---
title: "Red blood cell transfusion at a hemoglobin threshold of seven g/dL in critically ill patients: A target trial emulation"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: united
  word_document:
    toc: yes
---

# Setup
```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(tableone)
library(zoo)
library(epiR)
library(DescTools)
library(rdrobust)
library(rdd)
library(rddtools)
library(comorbidity)
library(EValue)
library(boot)
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(TZ = "EST")
set.seed(14)

#CUSTOM FUNCTIONS
na.locf2 <- function(x) {na.locf(x, na.rm = FALSE)}
```

# DATA WRANGLING
## Import - MIMIC
```{r import, echo=FALSE}
icu<-read.csv(file="icustay_detail.csv", stringsAsFactors = FALSE)
icutype<-read.csv(file="icutype.csv", stringsAsFactors = FALSE)
charlson<-read.csv(file="charlson.csv", stringsAsFactors = FALSE)
sofa<-read.csv(file="sofa.csv", stringsAsFactors = FALSE)
sep<-read.csv(file="sepsis3.csv", stringsAsFactors = FALSE)
cbc<-read.csv(file="cbc.csv", stringsAsFactors = FALSE)
prbc<-read.csv(file="prbc.csv", stringsAsFactors = FALSE)
mb<-read.csv(file="major_bleeding.csv", stringsAsFactors = FALSE)
mv<-read.csv(file="mv.csv", stringsAsFactors = FALSE)
press<-read.csv(file="vasopressor.csv", stringsAsFactors = FALSE)
bg<-read.csv(file="bg.csv", stringsAsFactors = FALSE)
```

## Import - eICU 
```{r import_eicu, echo=FALSE}
icu_eicu<-read.csv(file="eicu_icu.csv", stringsAsFactors = FALSE)
charlson_eicu<-read.csv(file="eicu_icd_codes.csv", stringsAsFactors = FALSE)
sofa_eicu<-read.csv(file="eicu_sofa_hourly_worst.csv", stringsAsFactors = FALSE)
sep_eicu_admitdx<-read.csv(file="eicu_sepsis_admitdx.csv", stringsAsFactors = FALSE)
sep_eicu_dx<-read.csv(file="eicu_sepsis_dx.csv", stringsAsFactors = FALSE)
hgb_eicu<-read.csv(file="eicu_hgb.csv", stringsAsFactors = FALSE)
prbc_eicu1<-read.csv(file="eicu_prbc.csv", stringsAsFactors = FALSE)
prbc_eicu2<-read.csv(file="eicu_prbc2.csv", stringsAsFactors = FALSE)
prbc_eicu3<-read.csv(file="eicu_prbc3.csv", stringsAsFactors = FALSE)
mb_eicu<-read.csv(file="eicu_major_bleeding.csv", stringsAsFactors = FALSE)
```


## Time and baseline table wrangling - MIMIC
```{r datawrangling 1, echo=FALSE}
hgb<-cbc[!is.na(cbc$hemoglobin),]
hgb$hgb_time<-as.numeric(as.POSIXct(hgb$charttime))/60 #minutes
hgb$hgb<-hgb$hemoglobin
hgb<-hgb[!is.na(hgb$hadm_id),]
sofa$sofa_time<-as.numeric(as.POSIXct(sofa$starttime))/60 #minutes
sofa$sofa<-sofa$sofa_24hours
prbc$prbc_time<-as.numeric(as.POSIXct(prbc$starttime))/60 #minutes
prbc$prbc<-1
sep$sepsis_time<-as.numeric(as.POSIXct(sep$suspected_infection_time))/60 #minutes
sep$sep<-1
charlson$ami<-0
charlson$ami[charlson$myocardial_infarct==1]<-1
charlson$charlson<-charlson$charlson_comorbidity_index
mb$mb<-1
mb<-distinct(mb[,c("subject_id","hadm_id","mb")])
icu$icu_admission_time<-as.numeric(as.POSIXct(icu$icu_intime))/60 #minutes
icu$icu_discharge_time<-as.numeric(as.POSIXct(icu$icu_outtime))/60 #minutes
icu$hospital_discharge_time<-as.numeric(as.POSIXct(icu$dischtime))/60 #minutes
icu$age<-icu$admission_age
icu<-left_join(icu, icutype[,c("stay_id","first_careunit")])
icu<-left_join(icu,mb)
icu$mb[is.na(icu$mb)]<-0
icu<-left_join(icu,sep)
icu$sep[is.na(icu$sep)]<-0
icu<-left_join(icu,charlson)
icu$female<-NA
icu$female[icu$gender=="M"]<-0
icu$female[icu$gender=="F"]<-1
icu$female<-as.numeric(icu$female)
imv<-mv[mv$ventilation_status=="InvasiveVent",]
imv$imv<-1
imv$starttime<-as.numeric(as.POSIXct(imv$starttime))/60 #minutes
imv$endtime<-as.numeric(as.POSIXct(imv$endtime))/60 #minutes
press$press<-1
press$starttime<-as.numeric(as.POSIXct(press$starttime))/60 #minutes
press$endtime<-as.numeric(as.POSIXct(press$endtime))/60 #minutes
dead1<-icu[icu$hospital_expire_flag==1,]
dead1$sofa<-25
dead1$sofa_time<-dead1$hospital_discharge_time
msofa<-full_join(sofa[,c("stay_id","sofa","sofa_time","respiration_24hours","coagulation_24hours","liver_24hours","cardiovascular_24hours","cns_24hours","renal_24hours")],dead1[,c("stay_id","sofa","sofa_time")])
msofa$msofa<-msofa$sofa
msofa<-msofa %>% group_by(stay_id, sofa_time) %>% arrange(desc(msofa)) %>% slice(1L)
bg$lac_time<-as.numeric(as.POSIXct(bg$charttime))/60 #minutes
bg$lac<-bg$lactate
lac<-bg[!is.na(bg$lactate),c("subject_id","hadm_id","lac_time","lac")]
```
## Time and baseline table wrangling - eICU 
```{r datawrangling1_eicu, echo=FALSE}
edead1<-icu_eicu[icu_eicu$hospital_expire_flag==1,]
edead1$sofa<-25
edead1$sofa_time<-edead1$hospitaldischargeoffset
sofa_eicu$sofa_time<-sofa_eicu$time
sofa_eicu$sofa<-sofa_eicu$max_totalsofa_last_24
emsofa<-full_join(sofa_eicu[,c("patientunitstayid","sofa","sofa_time")],edead1[,c("patientunitstayid","sofa","sofa_time")])
emsofa$msofa<-emsofa$sofa
emsofa<-emsofa %>% group_by(patientunitstayid, sofa_time) %>% arrange(desc(msofa)) %>% slice(1L)
icu_eicu$age<-as.numeric(icu_eicu$age)
icu_eicu<-icu_eicu[!is.na(icu_eicu$age),]
sep_eicu_admitdx$sepsis<-1
sep_eicu_dx$sepsis<-1
esep<-full_join(sep_eicu_admitdx, sep_eicu_dx)
```


## Cohort creation - Include first day sensitivity analysis
```{r first_day_sa}
icu1<-icu 

# limiting to relevent icus
icu2<-icu1[icu1$first_careunit%in% c("Medical Intensive Care Unit (MICU)", "Medical/Surgical Intensive Care Unit (MICU/SICU)","Cardiac Vascular Intensive Care Unit (CVICU)","Coronary Care Unit (CCU)","Neuro Surgical Intensive Care Unit (Neuro SICU)","Surgical Intensive Care Unit (SICU)","Trauma SICU (TSICU)"),]
ds<-left_join(icu2[,c("subject_id","hadm_id","stay_id","icu_admission_time","icu_discharge_time","age","female","charlson","sep","ami","mb","hospital_expire_flag")], hgb[,c("subject_id","hadm_id","hgb","hgb_time")])
ds1<-ds[!is.na(ds$hgb_time),]
ds1$min_from_icu_admission<-ds1$hgb_time-ds1$icu_admission_time
ds1$min_from_icu_discharge<-ds1$hgb_time-ds1$icu_discharge_time
ds2<-ds1[ds1$min_from_icu_admission>=0 & ds1$min_from_icu_admission<40320 & ds1$min_from_icu_discharge<=(-1440),] #limiting to during icu stay

# prbc
prbc1<-left_join(prbc,icu2[,c("subject_id","hadm_id","stay_id","icu_admission_time","icu_discharge_time","age","female","charlson","sep","ami","mb")])
prbc1$min_from_icu_admission<-prbc1$prbc_time-prbc1$icu_admission_time
ds3<-full_join(ds2, prbc1[,c("subject_id","hadm_id","stay_id","prbc_time","prbc","min_from_icu_admission")])
ds4<-ds3 %>% group_by(stay_id) %>% arrange(min_from_icu_admission) %>% mutate(prbc_time2=lead(prbc_time))
ds4$hgb_prbc_time<-ds4$prbc_time2-ds4$hgb_time
ds4$prbc_ex<-0
ds4$prbc_ex[!is.na(ds4$hgb_prbc_time) & ds4$hgb_prbc_time<1440]<-1
ds5<-ds4[!is.na(ds4$hgb),]

ds5$day<-NA
ds5$day[ds5$min_from_icu_admission>=0 & ds5$min_from_icu_admission<1440]<-1
ds5$day[ds5$min_from_icu_admission>=1440 & ds5$min_from_icu_admission<1440*2]<-2
ds5$day[ds5$min_from_icu_admission>=1440*2 & ds5$min_from_icu_admission<1440*3]<-3
ds5$day[ds5$min_from_icu_admission>=1440*3 & ds5$min_from_icu_admission<1440*4]<-4
ds5$day[ds5$min_from_icu_admission>=1440*4 & ds5$min_from_icu_admission<1440*5]<-5
ds5$day[ds5$min_from_icu_admission>=1440*5 & ds5$min_from_icu_admission<1440*6]<-6
ds5$day[ds5$min_from_icu_admission>=1440*6 & ds5$min_from_icu_admission<1440*7]<-7
ds5$day[ds5$min_from_icu_admission>=1440*7 & ds5$min_from_icu_admission<1440*8]<-8
ds5$day[ds5$min_from_icu_admission>=1440*8 & ds5$min_from_icu_admission<1440*9]<-9
ds5$day[ds5$min_from_icu_admission>=1440*9 & ds5$min_from_icu_admission<1440*10]<-10
ds5$day[ds5$min_from_icu_admission>=1440*10 & ds5$min_from_icu_admission<1440*11]<-11
ds5$day[ds5$min_from_icu_admission>=1440*11 & ds5$min_from_icu_admission<1440*12]<-12
ds5$day[ds5$min_from_icu_admission>=1440*12 & ds5$min_from_icu_admission<1440*13]<-13
ds5$day[ds5$min_from_icu_admission>=1440*13 & ds5$min_from_icu_admission<1440*14]<-14
ds5$day[ds5$min_from_icu_admission>=1440*14 & ds5$min_from_icu_admission<1440*15]<-15
ds5$day[ds5$min_from_icu_admission>=1440*15 & ds5$min_from_icu_admission<1440*16]<-16
ds5$day[ds5$min_from_icu_admission>=1440*16 & ds5$min_from_icu_admission<1440*17]<-17
ds5$day[ds5$min_from_icu_admission>=1440*17 & ds5$min_from_icu_admission<1440*18]<-18
ds5$day[ds5$min_from_icu_admission>=1440*18 & ds5$min_from_icu_admission<1440*19]<-19
ds5$day[ds5$min_from_icu_admission>=1440*19 & ds5$min_from_icu_admission<1440*20]<-20
ds5$day[ds5$min_from_icu_admission>=1440*20 & ds5$min_from_icu_admission<1440*21]<-21
ds5$day[ds5$min_from_icu_admission>=1440*21 & ds5$min_from_icu_admission<1440*22]<-22
ds5$day[ds5$min_from_icu_admission>=1440*22 & ds5$min_from_icu_admission<1440*23]<-23
ds5$day[ds5$min_from_icu_admission>=1440*23 & ds5$min_from_icu_admission<1440*24]<-24
ds5$day[ds5$min_from_icu_admission>=1440*24 & ds5$min_from_icu_admission<1440*25]<-25
ds5$day[ds5$min_from_icu_admission>=1440*25 & ds5$min_from_icu_admission<1440*26]<-26
ds5$day[ds5$min_from_icu_admission>=1440*26 & ds5$min_from_icu_admission<1440*27]<-27
ds5$day[ds5$min_from_icu_admission>=1440*27 & ds5$min_from_icu_admission<1440*28]<-28

ds5<-ds5 %>% group_by(stay_id, day) %>% arrange(hgb) %>% slice(1L)

#sofa
msofa1<-left_join(ds5, msofa[,c("stay_id","sofa","msofa","sofa_time","respiration_24hours","coagulation_24hours","liver_24hours","cardiovascular_24hours","cns_24hours","renal_24hours")])
msofa1$hgb_sofa_time<-msofa1$sofa_time-msofa1$hgb_time
msofa1$msofa_nobili<-msofa1$msofa-msofa1$liver_24hours
sofa_out<-msofa1[!is.na(msofa1$hgb_sofa_time) & msofa1$hgb_sofa_time>=1440 & msofa1$hgb_sofa_time<4320,] %>% group_by(stay_id, hgb_time) %>% arrange(desc(msofa)) %>% slice(1L)
sofa_out$msofa_out<-sofa_out$msofa
sofa_out$respiration_out<-sofa_out$respiration_24hours
sofa_out$coagulation_out<-sofa_out$coagulation_24hours
sofa_out$liver_out<-sofa_out$liver_24hours
sofa_out$cardiovascular_out<-sofa_out$cardiovascular_24hours
sofa_out$cns_out<-sofa_out$cns_24hours
sofa_out$renal_out<-sofa_out$renal_24hours

sofa_out_nobili<-msofa1[!is.na(msofa1$hgb_sofa_time) & msofa1$hgb_sofa_time>=1440 & msofa1$hgb_sofa_time<4320,] %>% group_by(stay_id, hgb_time) %>% arrange(desc(msofa)) %>% slice(1L)
sofa_out_nobili$msofa_out_nobili<-sofa_out_nobili$msofa_nobili

sofa_co<-msofa1[!is.na(msofa1$hgb_sofa_time) & msofa1$hgb_sofa_time>-1440 & msofa1$hgb_sofa_time<=0,] %>% group_by(stay_id, hgb_time) %>% arrange(desc(sofa_time)) %>% slice(1L)
sofa_co$sofa_co<-sofa_co$msofa
ds6a<-left_join(ds5, sofa_out[,c("stay_id","hgb_time","msofa_out","respiration_out","coagulation_out","liver_out","cardiovascular_out","cns_out","renal_out")])
ds6b<-left_join(ds6a, sofa_out_nobili[,c("stay_id","hgb_time","msofa_out_nobili")])
ds7<-left_join(ds6b, sofa_co[,c("stay_id","hgb_time","sofa_co")])
ds8<-ds7[!is.na(ds7$msofa_out) & !is.na(ds7$sofa_co),] #complete cases of outcome and sofa covariable

#imv wrangling
imv1<-left_join(ds8, imv[,c("stay_id","starttime","endtime","imv")])
imv1$imv_co<-0
imv1$imv_co[imv1$starttime<=imv1$hgb_time & imv1$endtime>imv1$hgb_time]<-1
imv1$imv_out<-0
imv1$imv_out[imv1$starttime<imv1$hgb_time+4320 & imv1$endtime>=imv1$hgb_time+1440]<-1
imv_co<-imv1 %>% group_by(stay_id, hgb_time) %>% arrange(desc(imv_co)) %>% slice(1L)
imv_out<-imv1 %>% group_by(stay_id, hgb_time) %>% arrange(desc(imv_out)) %>% slice(1L)
ds9<-left_join(ds8, imv_co[,c("stay_id","hgb_time","imv_co")])
ds10<-left_join(ds9, imv_out[,c("stay_id","hgb_time","imv_out")])

#pressor wrangling
press1<-left_join(ds10, press[,c("stay_id","starttime","endtime","press")])
press1$press_co<-0
press1$press_co[press1$starttime<=press1$hgb_time & press1$endtime>press1$hgb_time]<-1
press1$press_out<-0
press1$press_out[press1$starttime<press1$hgb_time+4320 & press1$endtime>=press1$hgb_time+1440]<-1
press_co<-press1 %>% group_by(stay_id, hgb_time) %>% arrange(desc(press_co)) %>% slice(1L)
press_out<-press1 %>% group_by(stay_id, hgb_time) %>% arrange(desc(press_out)) %>% slice(1L)
ds11<-left_join(ds10, press_co[,c("stay_id","hgb_time","press_co")])
ds12<-left_join(ds11, press_out[,c("stay_id","hgb_time","press_out")])

#hgb outcome wrangling
hgb_out<-hgb[,c("subject_id","hadm_id","hgb","hgb_time")]
hgb_out$hgb_out_time<-hgb_out$hgb_time
hgb_out$hgb_out<-hgb_out$hgb
hgb_out<-left_join(ds12, hgb_out[,c("subject_id","hadm_id","hgb_out","hgb_out_time")])
hgb_out$hgb_hgb_out_time<-hgb_out$hgb_out_time-hgb_out$hgb_time
hgb_out<-hgb_out[!is.na(hgb_out$hgb_hgb_out_time) & hgb_out$hgb_hgb_out_time>=1440 & hgb_out$hgb_hgb_out_time<4320,]%>% group_by(stay_id,hgb_time) %>% arrange(hgb_hgb_out_time) %>% slice(1L)
ds13<-left_join(ds12, hgb_out[,c("stay_id","hgb_time","hgb_out")])

#maximum lactate outcome wrangling
lac1<-left_join(ds5, lac[,c("subject_id","hadm_id","lac","lac_time")])
lac1$hgb_lac_time<-lac1$lac_time-lac1$hgb_time
lac_out<-lac1[!is.na(lac1$hgb_lac_time) & lac1$hgb_lac_time>=1440 & lac1$hgb_lac_time<4320,] %>% group_by(stay_id, hgb_time) %>% arrange(desc(lac)) %>% slice(1L)
lac_out$lac_out<-lac_out$lac
ds14<-left_join(ds13, lac_out[,c("stay_id","hgb_time","lac_out")])
ds16<-ds14

## reversed hgb for rdd
ds16$reverse_normalized_hgb<--(ds16$hgb-6.9)

#final
ds17<-ds16[ds16$ami==0,]
ds18<-ds17[ds17$mb==0,]
f<-ds18
f$count<-1
```



## Cohort creation - eICU  
```{r datawrangling2_eicu, echo=FALSE}
# charlson
echar9<-comorbidity(charlson_eicu, id="patientunitstayid", code="icd9",icd = "icd9", score="charlson", assign0=TRUE)
echar9$score9<-echar9$score
echar9$ami9<-echar9$ami
echar10<-comorbidity(charlson_eicu, id="patientunitstayid", code="icd10",icd = "icd10", score="charlson", assign0=TRUE)
echar10$score10<-echar10$score
echar10$ami10<-echar10$ami
echar<-full_join(echar9[,c("patientunitstayid","score9","ami9")],echar10[,c("patientunitstayid","score10","ami10")])
echar$charlson<-pmax(echar$score9, echar$score10)
echar$ami<-pmax(echar$ami9, echar$ami10)
eicu<-left_join(echar[,c("patientunitstayid","charlson","ami")], icu_eicu)

# limiting to icu stay and excluding first 24 hours and at 28 days for hemoglobin measurements
e<-left_join(eicu, hgb_eicu)
e$min_from_eicu_discharge<-e$min_from_admission-e$unitdischargeoffset
e1<-e[!is.na(e$min_from_admission) & e$min_from_admission>=1440 & e$min_from_admission<40320 & e$min_from_eicu_discharge<=(-1440),]
e1$hgb_time<-e1$min_from_admission

# adding in sepsis, major bleeding
e2<-left_join(e1, esep)
e2$sepsis[is.na(e2$sepsis)]<-0
e3<-left_join(e2, mb_eicu)
e3$mb[is.na(e3$mb)]<-0

# removing hospitals where no prbcs are recorded
ehosp<-full_join(e3,prbc_eicu1[,c("patientunitstayid","prbc")])
ehosp<-full_join(ehosp,prbc_eicu2[,c("patientunitstayid","prbc")])
ehosp<-full_join(ehosp,prbc_eicu3[,c("patientunitstayid","prbc")])
ehosp1<-distinct(ehosp[!is.na(ehosp$prbc) & !is.na(ehosp$hospitalid),c("hospitalid","prbc")])
ehosp1$ehosp<-1
e3<-left_join(ehosp1[,c("hospitalid","ehosp")], e3)

# prbc
eprbc<-full_join(prbc_eicu1, prbc_eicu2)
eprbc<-full_join(eprbc, prbc_eicu3)
eprbc$prbc_time<-eprbc$min_from_admission

e4<-full_join(e3[,c("patientunitstayid","hgb","hgb_time","min_from_admission")], eprbc)
e5<-e4 %>% group_by(patientunitstayid) %>% arrange(min_from_admission) %>% mutate(prbc_time2=lead(prbc_time))
e5$hgb_prbc_time<-e5$prbc_time2-e5$hgb_time
e5$prbc_ex<-0
e5$prbc_ex[!is.na(e5$hgb_prbc_time) & e5$hgb_prbc_time<1440]<-1
e6<-e5[!is.na(e5$hgb),]

e6$day<-NA
e6$day[e6$min_from_admission>=0 & e6$min_from_admission<1440]<-1
e6$day[e6$min_from_admission>=1440 & e6$min_from_admission<1440*2]<-2
e6$day[e6$min_from_admission>=1440*2 & e6$min_from_admission<1440*3]<-3
e6$day[e6$min_from_admission>=1440*3 & e6$min_from_admission<1440*4]<-4
e6$day[e6$min_from_admission>=1440*4 & e6$min_from_admission<1440*5]<-5
e6$day[e6$min_from_admission>=1440*5 & e6$min_from_admission<1440*6]<-6
e6$day[e6$min_from_admission>=1440*6 & e6$min_from_admission<1440*7]<-7
e6$day[e6$min_from_admission>=1440*7 & e6$min_from_admission<1440*8]<-8
e6$day[e6$min_from_admission>=1440*8 & e6$min_from_admission<1440*9]<-9
e6$day[e6$min_from_admission>=1440*9 & e6$min_from_admission<1440*10]<-10
e6$day[e6$min_from_admission>=1440*10 & e6$min_from_admission<1440*11]<-11
e6$day[e6$min_from_admission>=1440*11 & e6$min_from_admission<1440*12]<-12
e6$day[e6$min_from_admission>=1440*12 & e6$min_from_admission<1440*13]<-13
e6$day[e6$min_from_admission>=1440*13 & e6$min_from_admission<1440*14]<-14
e6$day[e6$min_from_admission>=1440*14 & e6$min_from_admission<1440*15]<-15
e6$day[e6$min_from_admission>=1440*15 & e6$min_from_admission<1440*16]<-16
e6$day[e6$min_from_admission>=1440*16 & e6$min_from_admission<1440*17]<-17
e6$day[e6$min_from_admission>=1440*17 & e6$min_from_admission<1440*18]<-18
e6$day[e6$min_from_admission>=1440*18 & e6$min_from_admission<1440*19]<-19
e6$day[e6$min_from_admission>=1440*19 & e6$min_from_admission<1440*20]<-20
e6$day[e6$min_from_admission>=1440*20 & e6$min_from_admission<1440*21]<-21
e6$day[e6$min_from_admission>=1440*21 & e6$min_from_admission<1440*22]<-22
e6$day[e6$min_from_admission>=1440*22 & e6$min_from_admission<1440*23]<-23
e6$day[e6$min_from_admission>=1440*23 & e6$min_from_admission<1440*24]<-24
e6$day[e6$min_from_admission>=1440*24 & e6$min_from_admission<1440*25]<-25
e6$day[e6$min_from_admission>=1440*25 & e6$min_from_admission<1440*26]<-26
e6$day[e6$min_from_admission>=1440*26 & e6$min_from_admission<1440*27]<-27
e6$day[e6$min_from_admission>=1440*27 & e6$min_from_admission<1440*28]<-28

e6<-e6 %>% group_by(patientunitstayid, day) %>% arrange(hgb) %>% slice(1L)

#sofa
emsofa1<-left_join(e6, emsofa[,c("patientunitstayid","msofa","sofa_time")])
emsofa1$hgb_sofa_time<-emsofa1$sofa_time-emsofa1$hgb_time
esofa_out<-emsofa1[!is.na(emsofa1$hgb_sofa_time) & emsofa1$hgb_sofa_time>=1440 & emsofa1$hgb_sofa_time<4320,] %>% group_by(patientunitstayid, hgb_time) %>% arrange(desc(msofa)) %>% slice(1L)
esofa_out$msofa_out<-esofa_out$msofa

esofa_co<-emsofa1[!is.na(emsofa1$hgb_sofa_time) & emsofa1$hgb_sofa_time>-1440 & emsofa1$hgb_sofa_time<=0,] %>% group_by(patientunitstayid, hgb_time) %>% arrange(desc(sofa_time)) %>% slice(1L)
esofa_co$sofa_co<-esofa_co$msofa
e7<-left_join(e6, esofa_out[,c("patientunitstayid","hgb_time","msofa_out")])
e8<-left_join(e7, esofa_co[,c("patientunitstayid","hgb_time","sofa_co")])
e9<-e8[!is.na(e8$msofa_out) & !is.na(e8$sofa_co),] #complete cases of outcome and sofa covariable

## reversed hgb for rdd
e9$reverse_normalized_hgb<--(e9$hgb-6.9)

#final
e10<-left_join(e9, distinct(e3[,c("patientunitstayid","sepsis","ami","mb","age","charlson","female","uniquepid")]))
e11<-e10
e12<-e11[e11$ami==0,]
e13<-e12[e12$mb==0,]
```


## Cohort creation  - MIMIC
```{r datawrangling2, echo=FALSE}
icu1<-icu 

# limiting to relevent icus
icu2<-icu1[icu1$first_careunit%in% c("Medical Intensive Care Unit (MICU)", "Medical/Surgical Intensive Care Unit (MICU/SICU)","Cardiac Vascular Intensive Care Unit (CVICU)","Coronary Care Unit (CCU)","Neuro Surgical Intensive Care Unit (Neuro SICU)","Surgical Intensive Care Unit (SICU)","Trauma SICU (TSICU)"),]
ds<-left_join(icu2[,c("subject_id","hadm_id","stay_id","icu_admission_time","icu_discharge_time","age","female","charlson","sep","ami","mb","hospital_expire_flag")], hgb[,c("subject_id","hadm_id","hgb","hgb_time")])
ds1<-ds[!is.na(ds$hgb_time),]
ds1$min_from_icu_admission<-ds1$hgb_time-ds1$icu_admission_time
ds1$min_from_icu_discharge<-ds1$hgb_time-ds1$icu_discharge_time
ds2<-ds1[ds1$min_from_icu_admission>=1440 & ds1$min_from_icu_admission<40320 & ds1$min_from_icu_discharge<=(-1440),] #limiting to during icu stay

# prbc
prbc1<-left_join(prbc,icu2[,c("subject_id","hadm_id","stay_id","icu_admission_time","icu_discharge_time","age","female","charlson","sep","ami","mb")])
prbc1$min_from_icu_admission<-prbc1$prbc_time-prbc1$icu_admission_time
ds3<-full_join(ds2, prbc1[,c("subject_id","hadm_id","stay_id","prbc_time","prbc","min_from_icu_admission")])
ds4<-ds3 %>% group_by(stay_id) %>% arrange(min_from_icu_admission) %>% mutate(prbc_time2=lead(prbc_time))
ds4$hgb_prbc_time<-ds4$prbc_time2-ds4$hgb_time
ds4$prbc_ex<-0
ds4$prbc_ex[!is.na(ds4$hgb_prbc_time) & ds4$hgb_prbc_time<1440]<-1
ds5<-ds4[!is.na(ds4$hgb),]

ds5$day<-NA
ds5$day[ds5$min_from_icu_admission>=0 & ds5$min_from_icu_admission<1440]<-1
ds5$day[ds5$min_from_icu_admission>=1440 & ds5$min_from_icu_admission<1440*2]<-2
ds5$day[ds5$min_from_icu_admission>=1440*2 & ds5$min_from_icu_admission<1440*3]<-3
ds5$day[ds5$min_from_icu_admission>=1440*3 & ds5$min_from_icu_admission<1440*4]<-4
ds5$day[ds5$min_from_icu_admission>=1440*4 & ds5$min_from_icu_admission<1440*5]<-5
ds5$day[ds5$min_from_icu_admission>=1440*5 & ds5$min_from_icu_admission<1440*6]<-6
ds5$day[ds5$min_from_icu_admission>=1440*6 & ds5$min_from_icu_admission<1440*7]<-7
ds5$day[ds5$min_from_icu_admission>=1440*7 & ds5$min_from_icu_admission<1440*8]<-8
ds5$day[ds5$min_from_icu_admission>=1440*8 & ds5$min_from_icu_admission<1440*9]<-9
ds5$day[ds5$min_from_icu_admission>=1440*9 & ds5$min_from_icu_admission<1440*10]<-10
ds5$day[ds5$min_from_icu_admission>=1440*10 & ds5$min_from_icu_admission<1440*11]<-11
ds5$day[ds5$min_from_icu_admission>=1440*11 & ds5$min_from_icu_admission<1440*12]<-12
ds5$day[ds5$min_from_icu_admission>=1440*12 & ds5$min_from_icu_admission<1440*13]<-13
ds5$day[ds5$min_from_icu_admission>=1440*13 & ds5$min_from_icu_admission<1440*14]<-14
ds5$day[ds5$min_from_icu_admission>=1440*14 & ds5$min_from_icu_admission<1440*15]<-15
ds5$day[ds5$min_from_icu_admission>=1440*15 & ds5$min_from_icu_admission<1440*16]<-16
ds5$day[ds5$min_from_icu_admission>=1440*16 & ds5$min_from_icu_admission<1440*17]<-17
ds5$day[ds5$min_from_icu_admission>=1440*17 & ds5$min_from_icu_admission<1440*18]<-18
ds5$day[ds5$min_from_icu_admission>=1440*18 & ds5$min_from_icu_admission<1440*19]<-19
ds5$day[ds5$min_from_icu_admission>=1440*19 & ds5$min_from_icu_admission<1440*20]<-20
ds5$day[ds5$min_from_icu_admission>=1440*20 & ds5$min_from_icu_admission<1440*21]<-21
ds5$day[ds5$min_from_icu_admission>=1440*21 & ds5$min_from_icu_admission<1440*22]<-22
ds5$day[ds5$min_from_icu_admission>=1440*22 & ds5$min_from_icu_admission<1440*23]<-23
ds5$day[ds5$min_from_icu_admission>=1440*23 & ds5$min_from_icu_admission<1440*24]<-24
ds5$day[ds5$min_from_icu_admission>=1440*24 & ds5$min_from_icu_admission<1440*25]<-25
ds5$day[ds5$min_from_icu_admission>=1440*25 & ds5$min_from_icu_admission<1440*26]<-26
ds5$day[ds5$min_from_icu_admission>=1440*26 & ds5$min_from_icu_admission<1440*27]<-27
ds5$day[ds5$min_from_icu_admission>=1440*27 & ds5$min_from_icu_admission<1440*28]<-28

ds5<-ds5 %>% group_by(stay_id, day) %>% arrange(hgb) %>% slice(1L)

#sofa
msofa1<-left_join(ds5, msofa[,c("stay_id","sofa","msofa","sofa_time","respiration_24hours","coagulation_24hours","liver_24hours","cardiovascular_24hours","cns_24hours","renal_24hours")])
msofa1$hgb_sofa_time<-msofa1$sofa_time-msofa1$hgb_time
msofa1$msofa_nobili<-msofa1$msofa-msofa1$liver_24hours
sofa_out<-msofa1[!is.na(msofa1$hgb_sofa_time) & msofa1$hgb_sofa_time>=1440 & msofa1$hgb_sofa_time<4320,] %>% group_by(stay_id, hgb_time) %>% arrange(desc(msofa)) %>% slice(1L)
sofa_out$msofa_out<-sofa_out$msofa
sofa_out$respiration_out<-sofa_out$respiration_24hours
sofa_out$coagulation_out<-sofa_out$coagulation_24hours
sofa_out$liver_out<-sofa_out$liver_24hours
sofa_out$cardiovascular_out<-sofa_out$cardiovascular_24hours
sofa_out$cns_out<-sofa_out$cns_24hours
sofa_out$renal_out<-sofa_out$renal_24hours

sofa_out_nobili<-msofa1[!is.na(msofa1$hgb_sofa_time) & msofa1$hgb_sofa_time>=1440 & msofa1$hgb_sofa_time<4320,] %>% group_by(stay_id, hgb_time) %>% arrange(desc(msofa)) %>% slice(1L)
sofa_out_nobili$msofa_out_nobili<-sofa_out_nobili$msofa_nobili

sofa_co<-msofa1[!is.na(msofa1$hgb_sofa_time) & msofa1$hgb_sofa_time>-1440 & msofa1$hgb_sofa_time<=0,] %>% group_by(stay_id, hgb_time) %>% arrange(desc(sofa_time)) %>% slice(1L)
sofa_co$sofa_co<-sofa_co$msofa
ds6a<-left_join(ds5, sofa_out[,c("stay_id","hgb_time","msofa_out","respiration_out","coagulation_out","liver_out","cardiovascular_out","cns_out","renal_out")])
ds6b<-left_join(ds6a, sofa_out_nobili[,c("stay_id","hgb_time","msofa_out_nobili")])
ds7<-left_join(ds6b, sofa_co[,c("stay_id","hgb_time","sofa_co")])
ds8<-ds7[!is.na(ds7$msofa_out) & !is.na(ds7$sofa_co),] #complete cases of outcome and sofa covariable

#imv wrangling
imv1<-left_join(ds8, imv[,c("stay_id","starttime","endtime","imv")])
imv1$imv_co<-0
imv1$imv_co[imv1$starttime<=imv1$hgb_time & imv1$endtime>imv1$hgb_time]<-1
imv1$imv_out<-0
imv1$imv_out[imv1$starttime<imv1$hgb_time+4320 & imv1$endtime>=imv1$hgb_time+1440]<-1
imv_co<-imv1 %>% group_by(stay_id, hgb_time) %>% arrange(desc(imv_co)) %>% slice(1L)
imv_out<-imv1 %>% group_by(stay_id, hgb_time) %>% arrange(desc(imv_out)) %>% slice(1L)
ds9<-left_join(ds8, imv_co[,c("stay_id","hgb_time","imv_co")])
ds10<-left_join(ds9, imv_out[,c("stay_id","hgb_time","imv_out")])

#pressor wrangling
press1<-left_join(ds10, press[,c("stay_id","starttime","endtime","press")])
press1$press_co<-0
press1$press_co[press1$starttime<=press1$hgb_time & press1$endtime>press1$hgb_time]<-1
press1$press_out<-0
press1$press_out[press1$starttime<press1$hgb_time+4320 & press1$endtime>=press1$hgb_time+1440]<-1
press_co<-press1 %>% group_by(stay_id, hgb_time) %>% arrange(desc(press_co)) %>% slice(1L)
press_out<-press1 %>% group_by(stay_id, hgb_time) %>% arrange(desc(press_out)) %>% slice(1L)
ds11<-left_join(ds10, press_co[,c("stay_id","hgb_time","press_co")])
ds12<-left_join(ds11, press_out[,c("stay_id","hgb_time","press_out")])

#hgb outcome wrangling
hgb_out<-hgb[,c("subject_id","hadm_id","hgb","hgb_time")]
hgb_out$hgb_out_time<-hgb_out$hgb_time
hgb_out$hgb_out<-hgb_out$hgb
hgb_out<-left_join(ds12, hgb_out[,c("subject_id","hadm_id","hgb_out","hgb_out_time")])
hgb_out$hgb_hgb_out_time<-hgb_out$hgb_out_time-hgb_out$hgb_time
hgb_out<-hgb_out[!is.na(hgb_out$hgb_hgb_out_time) & hgb_out$hgb_hgb_out_time>=1440 & hgb_out$hgb_hgb_out_time<4320,]%>% group_by(stay_id,hgb_time) %>% arrange(hgb_hgb_out_time) %>% slice(1L)
ds13<-left_join(ds12, hgb_out[,c("stay_id","hgb_time","hgb_out")])

#maximum lactate outcome wrangling
lac1<-left_join(ds5, lac[,c("subject_id","hadm_id","lac","lac_time")])
lac1$hgb_lac_time<-lac1$lac_time-lac1$hgb_time
lac_out<-lac1[!is.na(lac1$hgb_lac_time) & lac1$hgb_lac_time>=1440 & lac1$hgb_lac_time<4320,] %>% group_by(stay_id, hgb_time) %>% arrange(desc(lac)) %>% slice(1L)
lac_out$lac_out<-lac_out$lac
ds14<-left_join(ds13, lac_out[,c("stay_id","hgb_time","lac_out")])
ds16<-ds14

## reversed hgb for rdd
ds16$reverse_normalized_hgb<--(ds16$hgb-6.9)

#final
ds17<-ds16[ds16$ami==0,]
ds18<-ds17[ds17$mb==0,]
d<-ds18
d$count<-1

#drop of 1g/dl day prior
d<-d %>% group_by(stay_id) %>% arrange(hgb_time) %>% mutate(one_point_drop=ifelse(hgb-lag(hgb)<=-1, 1,0))
```

# FIGURE 1 - MIMIC
## Number of patients in database 
```{r figure 1a}
nrow(icu %>% group_by(subject_id) %>% slice(1L)) 
```


## Number of patients admitted to a icu (excludes stepdown patients)
```{r figure 1b}
nrow(icu2 %>% group_by(subject_id) %>% slice(1L)) 
```
## Number of patients with a hgb between days 2-28 and not within 24 hours of discharge
```{r figure 1c}
nrow(ds2 %>% group_by(subject_id) %>% slice(1L))
```

## Number of patients with non-missing outcomes  
```{r figure 1d}
nrow(ds16 %>% group_by(subject_id) %>% slice(1L))
```

## Number of patients with  no myocardial infaraction diagnosis
```{r figure 1f}
nrow(ds17 %>% group_by(subject_id) %>% slice(1L))
```

## Number of patients in final cohort
```{r figure 1g}
nrow(d %>% group_by(subject_id) %>% slice(1L))
```

## Number of total hemoglobins in final cohort  
```{r figure 1h}
nrow(d)
```


# Table 1  
```{r table 1}
vars <- c("age","female","sofa_co","charlson","sep","imv_co","press_co")
catVars <-c("female","sep","mb","ami","press_co","imv_co")
nonNormalVars <- c("age","charlson","sofa_co")
tab1<-CreateTableOne(vars = vars, factorVars=catVars, data = d, test = FALSE)
print(tab1, nonnormal = nonNormalVars, noSpaces = TRUE, missing=TRUE)

tab2<-CreateTableOne(vars = vars, factorVars=catVars, data = d, test = FALSE, strata="prbc_ex")
print(tab2, nonnormal = nonNormalVars, noSpaces = TRUE, missing=TRUE)
```

# Hemoglobin median, IQR, range, and histogram
```{r histogram}
summary(d$hgb)

d$color<-0
d$color[d$reverse_normalized_hgb>=0]<-1
d$color<-factor(d$color)

ggplot(d, aes(x=reverse_normalized_hgb, fill=color))+geom_histogram(binwidth=0.1)+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("Count")+
  theme(legend.position = "none")

ggsave(filename="Figure_E3.tiff")
```

# Potential confounders discontinuity at the threshold
## Admission age
```{r admission_age_hgb}
summary(rdrobust(y=d$age, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$age, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(1.950, 1.553), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("Age - years")+
  geom_rect(aes(xmin=-1.950, xmax=1.553, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  coord_cartesian(ylim=c(50,70))

ggsave(filename="Figure_1a.tiff")
```

## Female sex
```{r female_sex_hgb}
summary(rdrobust(y=d$female, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$female, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(1.899, 1.643), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("Female sex - proportion")+
  geom_rect(aes(xmin=-1.899, xmax=1.643, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  coord_cartesian(ylim=c(0.25,0.75))

ggsave(filename="Figure_1b.tiff")
```


## Charlson Comorbidity Index
```{r charlson_hgb}
summary(rdrobust(y=d$charlson, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$charlson, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(2.188, 1.506), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("Charlson Comorbidity Score")+
  geom_rect(aes(xmin=-2.188, xmax=1.506, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  coord_cartesian(ylim=c(2,10))

ggsave(filename="Figure_1c.tiff")
```

## SOFA score  
```{r sofa_hgb}
summary(rdrobust(y=d$sofa_co, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$sofa_co, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(1.543, 1.200), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("SOFA score")+
  geom_rect(aes(xmin=-1.543, xmax=1.200, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  coord_cartesian(ylim=c(2,10))

ggsave(filename="Figure_1d.tiff")
```

## Use of invasive mechanical ventilation
```{r imv_hgb}
summary(rdrobust(y=d$imv_co, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$imv_co, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(1.707, 1.427), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("Invasive mechanical ventilation - proportion")+
  geom_rect(aes(xmin=-1.707, xmax=1.427, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  coord_cartesian(ylim=c(0.25,0.75))

ggsave(filename="Figure_1e.tiff")
```

## Use of vasopressors 
```{r vaso_hgb}
summary(rdrobust(y=d$press_co, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$press_co, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(1.944, 1.492), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("Vasopressors - proportion")+
  geom_rect(aes(xmin=-1.944, xmax=1.492, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  coord_cartesian(ylim=c(0.0,0.50))

ggsave(filename="Figure_1f.tiff")
```

## Sepsis diagnosis
```{r sep_hgb}
summary(rdrobust(y=d$sep, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$sep, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(1.461, 1.221), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("Sepsis diagnosis - proportion")+
  geom_rect(aes(xmin=-1.461, xmax=1.221, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  coord_cartesian(ylim=c(0.5,1.0))

ggsave(filename="Figure_1g.tiff")
```

# Transfusion in the 24 hours after hemoglobin discontinuity at the threshold
```{r prbc_hgb}
summary(rdrobust(y=d$prbc_ex, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$prbc_ex, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(0.610, 0.817), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("Blood transfusion - proportion")+
  geom_rect(aes(xmin=-0.610, xmax=0.817, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  coord_cartesian(ylim=c(0,1))

ggsave(filename="Figure_2a.tiff")
```

# Outcomes
## Primary Outcome - maximum SOFA in the 24-72 hours following hemoglobin 
### Sharp   
```{r sofa_outcome_itt}
summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(2.238, 1.186), covs=c(d$age+d$charlson+d$sofa_co+d$female+d$imv_co+d$press_co+d$sep), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
    ylim(5,12.5)+
  xlab("Hemoglobin - g/dL")+
  ylab("Modified SOFA 24-72 hours after hemoglobin")+
  geom_rect(aes(xmin=-2.238, xmax=1.186, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggsave(filename="Figure_2b.tiff")
```



### Fuzzy 
```{r sofa_outcome_fuzzy}
summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
```

#### E-value  
```{r evalue}
rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T)$coef
evalues.OLS(est=2.858, se=1.093, sd=sd(d$msofa_out))
```
### Sensitivity Analyses  
Fuzzy RD analyses only

#### Adjusted for potential confounders  
```{r sofa_outcome_covariates}
summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T, covs=c(d$age+d$female+d$charlson+d$sofa_co+d$imv_co+d$press_co+d$sep)))
```

#### Half bandwidth  
```{r sofa_outcome_half_bandwidth}
summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, h=c(1.065/2, 0.877/2), cluster=d$subject_id, all=T))
```

#### Double bandwidth  
```{r sofa_outcome_double_bandwith}
summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, h=c(1.065*2, 0.877*2), cluster=d$subject_id, all=T))
```

#### Equal bandwidth  
```{r sofa_outcome_equal_bandwith}
summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="mserd", cluster=d$subject_id, all=T))
```

#### Local quadratic rather than local linear regression  
```{r sofa_outcome_quadratic}
summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T, p=2))
```

#### Global polynomial approach rather than local linear regression  (3rd, 4th, and 5th degree)  
```{r sofa_outcome_globalpolynomial}
summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, h=c(-min(d$reverse_normalized_hgb),max(d$reverse_normalized_hgb)), p=3, cluster=d$subject_id, all=T))

summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, h=c(-min(d$reverse_normalized_hgb),max(d$reverse_normalized_hgb)), p=4, cluster=d$subject_id, all=T))

summary(rdrobust(y=d$msofa_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, h=c(-min(d$reverse_normalized_hgb),max(d$reverse_normalized_hgb)), p=5, cluster=d$subject_id, all=T))
```

#### Include first day  
```{r firstday_fuzzy}
summary(rdrobust(y=f$msofa_out, x=f$reverse_normalized_hgb, c=0, fuzzy=f$prbc_ex, bwselect="msetwo", cluster=f$subject_id, all=T))
```

#### Single randomly selected hemoglobin per patient ICU stay  
```{r day_fuzzy, ECHO=FALSE}
# random day
dr<-d %>% group_by(stay_id) %>% arrange(day) %>% sample_n(1)

summary(rdrobust(y=dr$prbc_ex, x=dr$reverse_normalized_hgb, c=0, bwselect="msetwo", all=T))
summary(rdrobust(y=dr$msofa_out, x=dr$reverse_normalized_hgb, c=0, bwselect="msetwo", all=T))
summary(rdrobust(y=dr$msofa_out, x=dr$reverse_normalized_hgb, fuzzy=dr$prbc_ex, c=0, bwselect="msetwo", all=T))
```

## Explanatory analyses    
```{r sofa_outcome_exploratory}
summary(rdrobust(y=d$cardiovascular_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
summary(rdrobust(y=d$coagulation_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
summary(rdrobust(y=d$cns_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
summary(rdrobust(y=d$liver_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
summary(rdrobust(y=d$renal_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
summary(rdrobust(y=d$respiration_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
summary(rdrobust(y=d$msofa_out_nobili, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
```
## Secondary outcomes  
### First hemoglobin in the 24-72 hours following hemoglobin     
#### Sharp  
```{r hgb_outcome_itt}
summary(rdrobust(y=d$hgb_out, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$hgb_out, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(0.653, 1.019), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
      ylim(5,10)+
  xlab("Hemoglobin - g/dL")+
  ylab("Maximum Hemoglobin 24-72 hours after hemoglobin")+
  geom_rect(aes(xmin=-0.653, xmax=1.019, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


#### Fuzzy  
```{r hgb_outcome_fuzzy}
summary(rdrobust(y=d$hgb_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
```

### Use of invasive mechanical ventilation in the 24-72 hours following hemoglobin  
#### Sharp  
```{r imv_outcome_itt}
summary(rdrobust(y=d$imv_out, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$imv_out, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(1.498, 1.186), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
      ylim(0.3,1)+
  xlab("Hemoglobin - g/dL")+
  ylab("Invasive mechanical ventilation use 24-72 hours after hemoglobin")+
  geom_rect(aes(xmin=-1.498, xmax=1.186, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())


```


#### Fuzzy  
```{r imv_outcome_fuzzy}
summary(rdrobust(y=d$imv_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
```


### Use of vasopressors in the 24-72 hours following hemoglobin    
#### Sharp   
```{r press_outcome_itt}
summary(rdrobust(y=d$press_out, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$press_out, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(1.944, 1.510), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
      ylim(0.2,1)+
  xlab("Hemoglobin - g/dL")+
  ylab("Vasopressor use 24-72 hours after hemoglobin")+
  geom_rect(aes(xmin=-1.944, xmax=1.510, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


#### Fuzzy  
```{r press_outcome_fuzzy}
summary(rdrobust(y=d$press_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
```

### Overal hospital death  
#### Sharp   
```{r death_outcome_itt}
summary(rdrobust(y=d$hospital_expire_flag, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$hospital_expire_flag, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(2.468, 1.719), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
      ylim(0.1,1)+
  xlab("Hemoglobin - g/dL")+
  ylab("Hospital Death - %")+
  geom_rect(aes(xmin=-2.468, xmax=1.498, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


#### Fuzzy  
```{r death_outcome_fuzzy}
summary(rdrobust(y=d$hospital_expire_flag, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
```


### Maximum lactate level in the 24-72 hours following hemoglobin  
#### Sharp   
```{r lactate_itt}
summary(rdrobust(y=d$lac_out, x=d$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=d$subject_id, all=T))

plot<-rdplot(y=d$lac_out, x=d$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(2.159, 1.424), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
      ylim(0,5)+
  xlab("Hemoglobin - g/dL")+
  ylab("Lactate level mmol/L 24-72 hours after hemoglobin")+
  geom_rect(aes(xmin=-2.159, xmax=1.424, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


#### Fuzzy  
```{r lactate_fuzzy}
summary(rdrobust(y=d$lac_out, x=d$reverse_normalized_hgb, c=0, fuzzy=d$prbc_ex, bwselect="msetwo", cluster=d$subject_id, all=T))
```




## Subgroup analyses  
### Septic Shock  
```{r septic_shock_fuzzy}
d$ss<-0
d$ss[d$press_co==1 & d$sep==1]<-1

summary(rdrobust(y=d$msofa_out[d$ss==0], x=d$reverse_normalized_hgb[d$ss==0], c=0, fuzzy=d$prbc_ex[d$ss==0], bwselect="msetwo", cluster=d$subject_id[d$ss==0], all=T))

summary(rdrobust(y=d$msofa_out[d$ss==1], x=d$reverse_normalized_hgb[d$ss==1], c=0, fuzzy=d$prbc_ex[d$ss==1], bwselect="msetwo", cluster=d$subject_id[d$ss==1], all=T))

#test for interaction
diff<-1.854-4.324
diff_se<-sqrt((1.091^2)+(2.436^2))
diff_z<-diff/diff_se
round((1-pnorm(abs(diff_z)))*2,2)
```

### Cardiac ICU  
```{r cardiac_icu_fuzzy}
g<-left_join(d, icu1[,c("subject_id","hadm_id","stay_id","first_careunit")])
g$cicu<-0
g$cicu[g$first_careunit=="Cardiac Vascular Intensive Care Unit (CVICU)" | g$first_careunit=="Coronary Care Unit (CCU)"]<-1

summary(rdrobust(y=g$msofa_out[g$cicu==0], x=g$reverse_normalized_hgb[g$cicu==0], c=0, fuzzy=g$prbc_ex[g$cicu==0], bwselect="msetwo", cluster=g$subject_id[g$cicu==0], all=T))

summary(rdrobust(y=g$msofa_out[g$cicu==1], x=g$reverse_normalized_hgb[g$cicu==1], c=0, fuzzy=g$prbc_ex[g$cicu==1], bwselect="msetwo", cluster=g$subject_id[g$cicu==1], all=T))

#test for interaction
diff<-2.931--0.032
diff_se<-sqrt((1.112^2)+(3.130^2))
diff_z<-diff/diff_se
round((1-pnorm(abs(diff_z)))*2,2)
```

## eICU sensitivity
### Number of patients in final cohort   
```{r figure 1ge}
nrow(e13 %>% group_by(uniquepid) %>% slice(1L))
```

### Number of total hemoglobins in final cohort  
```{r figure 1he}
nrow(e13)
```

### Transfusion in the 24 hours after hemoglobin discontinuity at the threshold  
```{r prbc_hgbe}
summary(rdrobust(y=e13$prbc_ex, x=e13$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=e13$uniquepid, all=T))

plot<-rdplot(y=e13$prbc_ex, x=e13$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(0.927, 0.929), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
  xlab("Hemoglobin - g/dL")+
  ylab("Blood transfusion - proportion")+
  geom_rect(aes(xmin=-0.927, xmax=0.929, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  coord_cartesian(ylim=c(0,1))

ggsave(filename="Figure_E4a.tiff")
```


### Primary Outcome - maximum SOFA in the 24-72 hours following hemoglobin assessment
#### Sharp  
```{r sofa_outcome_itte}
summary(rdrobust(y=e13$msofa_out, x=e13$reverse_normalized_hgb, c=0, bwselect="msetwo", cluster=e13$uniquepid, all=T))

plot<-rdplot(y=e13$msofa_out, x=e13$reverse_normalized_hgb, c=0, shade=F, ci=F, p=1, h=c(2.577, 1.767), kernel="triangular")
plot$rdplot+
  scale_x_reverse(breaks=c(2,1,0,-1.1,-2.1,-3.1,-4.1),labels=c(5,6,6.9,8,9,10,11), limits=c(2,-3.5))+
    ylim(5,15)+
  xlab("Hemoglobin - g/dL")+
  ylab("Modified SOFA 24-72 hours after hemoglobin")+
  geom_rect(aes(xmin=-2.577, xmax=1.767, ymin=-Inf, ymax=+Inf), alpha=1/10)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggsave(filename="Figure_E4b.tiff")
```

#### Fuzzy  
```{r sofa_outcome_fuzzye}
summary(rdrobust(y=e13$msofa_out, x=e13$reverse_normalized_hgb, c=0, fuzzy=e13$prbc_ex, bwselect="msetwo", cluster=e13$uniquepid, all=T))
```

